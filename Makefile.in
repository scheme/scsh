srcdir = @srcdir@
VPATH = @srcdir@
CC = @CC@
LD = ${CC}
DEFS = @DEFS@
LIBS = @LIBS@
CFLAGS = @CFLAGS@ @DYNAMIC_EXTERNALS_CFLAGS@
CPPFLAGS = @CPPFLAGS@
INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

LDFLAGS = @LDFLAGS@ @DYNAMIC_EXTERNALS_LDFLAGS@


prefix = @prefix@
exec_prefix = @exec_prefix@

bindir = @bindir@
libdir = @libdir@
incdir = @includedir@
manext = 1
mandir = @mandir@/man$(manext)
docdir = @docdir@
datarootdir = @datarootdir@
datadir = @datadir@

VERSION = 0.7
RUNNABLE = scsh
LIB = $(libdir)/scsh-$(VERSION)
SHARE = $(datadir)/scsh-$(VERSION)
lib_dirs_list = ("${prefix}/lib/scsh/modules" "${prefix}/lib/scsh/modules/${VERSION}")

SCHEME48VERSION =  1.9
SCHEME48VM = @S48DIR@/lib/scheme48-${SCHEME48VERSION}/scheme48vm
SCHEME48 = @SCHEME48@

COMPILED_LIBS = c/syscalls.so \
	c/tty.so \
	c/syscalls.so \
	c/tty-baud-rate-flags.so \
	c/tty-control-chars-info.so \
	c/tty-control-flags.so \
	c/tty-input-flags.so \
	c/tty-local-flags.so \
	c/tty-output-flags.so \
	c/tty-tcflow-flags.so \
	c/tty-tcflush-flags.so \
	c/tty-tcsetattr-flags.so

enough: scsh scsh.image go

test: enough
	$(srcdir)/build/test.sh $(srcdir)

c/%.so: c/%.c
	$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) -o $@ $< $(LIBS)

SCHEME = scheme/command-line.scm \
	 scheme/condition-handler.scm \
	 scheme/constance.scm \
	 scheme/continuation.scm \
	 scheme/directory.scm \
	 scheme/enumconst.scm \
	 scheme/environment.scm \
	 scheme/event.scm \
	 scheme/fdports.scm \
	 scheme/file.scm \
	 scheme/fileinfo.scm \
	 scheme/filemtch.scm \
	 scheme/filesys.scm \
	 scheme/fname.scm \
	 scheme/fname-system.scm \
	 scheme/fr.scm \
	 scheme/glob.scm \
	 scheme/dot-locking.scm \
	 scheme/here.scm \
	 scheme/lib-dirs.scm \
	 scheme/libscsh.scm \
	 scheme/low-interrupt.scm \
	 scheme/md5.scm \
	 scheme/meta-arg.scm \
	 scheme/newports.scm \
	 scheme/port-collect.scm \
	 scheme/process-high-level.scm \
	 scheme/process-state.scm \
	 scheme/process.scm \
	 scheme/procobj.scm \
	 scheme/pty.scm \
	 scheme/rdelim.scm \
	 scheme/resource.scm \
	 scheme/rw.scm \
	 scheme/scsh-condition.scm \
	 scheme/scsh-interfaces.scm \
	 scheme/scsh-package.scm \
	 scheme/scsh-read.scm \
	 scheme/scsh-version.scm \
	 scheme/signal.scm \
	 scheme/startup.scm \
	 scheme/stdio.scm \
	 scheme/stringcoll.scm \
	 scheme/syntax-helpers.scm \
	 scheme/syntax.scm \
	 scheme/system.scm \
	 scheme/temp-file.scm \
	 scheme/top.scm \
	 scheme/tty.scm \
	 scheme/tty-consts.scm \
	 scheme/user-group.scm \
	 scheme/utilities.scm \
	 scheme/weaktables.scm \
	 rx/packages.scm \
	 rx/re-match-syntax.scm \
	 rx/rx-lib.scm \
	 rx/parse.scm \
	 rx/re-subst.scm \
	 rx/simp.scm \
	 rx/posixstr.scm \
	 rx/re-syntax.scm \
	 rx/spencer.scm \
	 rx/re-fold.scm \
	 rx/re.scm \
	 rx/re-high.scm \
	 rx/re-low.scm \
	 rx/regress.scm

go: c/scsh-tramp.c
	$(CC) -o $@ $(CFLAGS) \
	-DVM=\"$(SCHEME48VM)\" \
	-DIMAGE=\"scsh.image\" \
	$(srcdir)/c/scsh-tramp.c

scsh: c/scsh-tramp.c
	$(CC) -o $@ $(CFLAGS) \
	-DVM=\"$(SCHEME48VM)\" \
	-DIMAGE=\"$(LIB)/scsh.image\" \
	$(srcdir)/c/scsh-tramp.c

LOADS = $(srcdir)/rx/interfaces.scm \
	$(srcdir)/rx/packages.scm \
	$(srcdir)/scheme/scsh-interfaces.scm \
	$(srcdir)/scheme/scsh-package.scm \
	$(srcdir)/scheme/lib/ccp-pack.scm \
	$(srcdir)/scheme/lib/char-package.scm

scsh.image: $(SCHEME) $(COMPILED_LIBS)
	$(srcdir)/build/build-image.sh $(srcdir) \
		"`pwd`/c/" '$@' '$(SCHEME48) -h 0' '$(LOADS)'

dirs:
	for dir in $(bindir) $(LIB) $(SHARE); do\
		{ mkdir -p $(DESTDIR)$$dir && [ -w $(DESTDIR)$$dir ]; } || {	\
			echo "$(DESTDIR)$$dir not a writable directory" >&2;	\
			exit 1;						\
	}								\
	done

install: enough dirs install-scsh-image install-scsh

install-scsh: scsh
        #install runner
	$(RM) $(DESTDIR)$(bindir)/$(RUNNABLE)
	$(INSTALL_PROGRAM) scsh $(DESTDIR)$(bindir)/$(RUNNABLE)

	for file in $(patsubst c/%,%,$(COMPILED_LIBS)) ; do \
	$(INSTALL) c/$$file $(DESTDIR)$(LIB)/$$file ; \
	done
        #install scheme source files
	for f in $(srcdir)/scheme/*.scm $(srcdir)/scheme/*/*.scm; \
	    do $(INSTALL_DATA) $$f $(DESTDIR)$(SHARE)/; done

install-scsh-image: install-scsh
	$(srcdir)/build/build-image.sh $(srcdir) \
		"$(LIB)/" '$(DESTDIR)$(LIB)/scsh.image' '$(SCHEME48) -h 0' '$(LOADS)'

clean:
	rm -rf c/*.o c/*.so c/*.dSYM *.sexpr scsh.image scsh go *.dSYM
